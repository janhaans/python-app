name: Test ARC Runner

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: arc-runner-set
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
      
      - name: Create RBAC permissions
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: arc-runner-cluster-reader
          rules:
          - apiGroups: [""]
            resources: ["nodes", "pods", "services", "namespaces"]
            verbs: ["get", "list"]
          - apiGroups: ["apps"]
            resources: ["deployments", "replicasets"]
            verbs: ["get", "list"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: arc-runner-cluster-reader-binding
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: arc-runner-cluster-reader
          subjects:
          - kind: ServiceAccount
            name: arc-runner-set-gha-rs-no-permission
            namespace: arc-runners
          EOF
      
      - name: Test runner
        run: |
          echo "Hello from ARC runner!"
          echo "Service Account: $(kubectl config current-context)"
          kubectl get nodes
          kubectl get pods -n arc-runners